/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ComponentFactoryResolver, ElementRef, Injector, ViewChild, ViewContainerRef } from '@angular/core';
import { Subject } from 'rxjs';
import { startWith, takeUntil, tap } from 'rxjs/operators';
import { Bus, cssClass, toCss } from './utils';
export class ToppyComponent {
    /**
     * @param {?} inj
     * @param {?} cd
     * @param {?} compResolver
     * @param {?} elRef
     */
    constructor(inj, cd, compResolver, elRef) {
        this.inj = inj;
        this.cd = cd;
        this.compResolver = compResolver;
        this.elRef = elRef;
        this.content = {
            type: "s" /* STRING */,
            data: '',
            props: {}
        };
        this.die = new Subject();
        this.pinj = Injector;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.el = this.elRef.nativeElement;
        this.wrapperEl = this.el.querySelector('.t-wrapper');
        /** @type {?} */
        let cls = ['t-container', this.config.containerClass, this.position.getClassName()];
        if (this.config.closeOnDocClick) {
            cls = cls.concat(['no-pointers']);
        }
        this.el.setAttribute('data-tid', this.tid);
        cssClass('add', cls, `[data-tid='${[this.tid]}']`);
        cssClass('add', [this.config.bodyClass]);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.listenPos().subscribe();
        if (this.content.type === "c" /* COMPONENT */) {
            this.compInstance = this.setComponent(this.content.props);
            Bus.send(this.tid, 't_compins', this.compInstance);
        }
    }
    /**
     * @param {?} props
     * @return {?}
     */
    setComponent(props) {
        /** @type {?} */
        const compRef = this.compOutlet.createComponent(this.compResolver.resolveComponentFactory((/** @type {?} */ (this.content.data))));
        Object.assign(compRef.instance, props);
        compRef.changeDetectorRef.detectChanges();
        return compRef.instance;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    updateTextContent(data) {
        if (this.content.type === "s" /* STRING */) {
            this.content.data = data;
            this.cd.detectChanges();
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        cssClass('remove', [this.config.bodyClass]);
        this.die.next(1);
        Bus.send(this.tid, 't_detach');
    }
    /**
     * @private
     * @return {?}
     */
    listenPos() {
        return Bus.listen(this.tid, 't_dynpos').pipe(startWith(1), takeUntil(this.die), tap(e => {
            if (!e || !e.x)
                return this.setPos();
            /** @type {?} */
            const coords = { left: e.x, top: e.y };
            this.wrapperEl.style = toCss(coords);
        }));
    }
    /**
     * @private
     * @return {?}
     */
    setPos() {
        const _a = this.position.getPositions(this.wrapperEl), { extra } = _a, coords = tslib_1.__rest(_a, ["extra"]);
        if (this.extra !== extra) {
            this.extra = extra;
            this.cd.detectChanges();
        }
        Object.assign(coords, { visibility: 'visible', opacity: '1' });
        this.wrapperEl.style = toCss(coords);
        Bus.send(this.tid, 't_posupdate');
    }
}
ToppyComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'toppy',
                template: "<div class=\"t-backdrop\" *ngIf=\"config.backdrop\" [ngClass]=\"config.backdropClass\"></div>\n<div class=\"t-wrapper\" [ngClass]=\"config.wrapperClass\" [class]=\"extra\" #wrapperEl>\n  <ng-container [ngSwitch]=\"content.type\">\n    <ng-container *ngSwitchCase=\"'s'\">\n      <div [class]=\"content.props.class\">{{ content.data }}</div>\n    </ng-container>\n    <ng-container *ngSwitchCase=\"'h'\"> <div [innerHTML]=\"content.data\"></div> </ng-container>\n    <ng-container *ngSwitchCase=\"'t'\">\n      <ng-container *ngTemplateOutlet=\"content.data; context: { $implicit: content.props }\"></ng-container>\n    </ng-container>\n    <ng-container *ngSwitchCase=\"'c'\"> <ng-template #compOutlet></ng-template> </ng-container>\n  </ng-container>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [":host{left:0;position:fixed;top:0;width:100%;height:100%;pointer-events:none}:host.no-pointers{pointer-events:all}:host .t-backdrop{left:0;position:fixed;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}:host>div.t-wrapper{position:absolute;visibility:hidden;opacity:0;transition:opacity .2s;overflow:hidden;pointer-events:all}"]
            }] }
];
/** @nocollapse */
ToppyComponent.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: ComponentFactoryResolver },
    { type: ElementRef }
];
ToppyComponent.propDecorators = {
    compOutlet: [{ type: ViewChild, args: ['compOutlet', { read: ViewContainerRef },] }]
};
if (false) {
    /** @type {?} */
    ToppyComponent.prototype.compOutlet;
    /** @type {?} */
    ToppyComponent.prototype.content;
    /** @type {?} */
    ToppyComponent.prototype.config;
    /** @type {?} */
    ToppyComponent.prototype.position;
    /** @type {?} */
    ToppyComponent.prototype.tid;
    /** @type {?} */
    ToppyComponent.prototype.el;
    /** @type {?} */
    ToppyComponent.prototype.wrapperEl;
    /** @type {?} */
    ToppyComponent.prototype.extra;
    /** @type {?} */
    ToppyComponent.prototype.pinj;
    /** @type {?} */
    ToppyComponent.prototype.compInstance;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.die;
    /** @type {?} */
    ToppyComponent.prototype.inj;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.cd;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.compResolver;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.elRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wcHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9wcHkvIiwic291cmNlcyI6WyJsaWIvdG9wcHkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUVMLHVCQUF1QixFQUN2QixpQkFBaUIsRUFDakIsU0FBUyxFQUNULHdCQUF3QixFQUN4QixVQUFVLEVBQ1YsUUFBUSxFQUdSLFNBQVMsRUFDVCxnQkFBZ0IsRUFDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUczRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFTL0MsTUFBTSxPQUFPLGNBQWM7Ozs7Ozs7SUFpQnpCLFlBQ1MsR0FBYSxFQUNaLEVBQXFCLEVBQ3JCLFlBQXNDLEVBQ3RDLEtBQWlCO1FBSGxCLFFBQUcsR0FBSCxHQUFHLENBQVU7UUFDWixPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBMEI7UUFDdEMsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQW5CM0IsWUFBTyxHQUFZO1lBQ2pCLElBQUksa0JBQW9CO1lBQ3hCLElBQUksRUFBRSxFQUFFO1lBQ1IsS0FBSyxFQUFFLEVBQUU7U0FDVixDQUFDO1FBU00sUUFBRyxHQUFlLElBQUksT0FBTyxFQUFFLENBQUM7UUFRdEMsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7SUFDdkIsQ0FBQzs7OztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ25DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsWUFB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XG4gIEFmdGVyVmlld0luaXQsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIEVsZW1lbnRSZWYsXG4gIEluamVjdG9yLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgVmlld0NoaWxkLFxuICBWaWV3Q29udGFpbmVyUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbnRlbnQsIENvbnRlbnRUeXBlLCBUSUQsIFRvcHB5Q29uZmlnIH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHsgVG9wcHlQb3NpdGlvbiB9IGZyb20gJy4vcG9zaXRpb24vcG9zaXRpb24nO1xuaW1wb3J0IHsgQnVzLCBjc3NDbGFzcywgdG9Dc3MgfSBmcm9tICcuL3V0aWxzJztcblxuQENvbXBvbmVudCh7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjb21wb25lbnQtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICd0b3BweScsXG4gIHRlbXBsYXRlVXJsOiAnLi90ZW1wbGF0ZS5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vc3R5bGVzLnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgVG9wcHlDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIEBWaWV3Q2hpbGQoJ2NvbXBPdXRsZXQnLCB7IHJlYWQ6IFZpZXdDb250YWluZXJSZWYgfSkgY29tcE91dGxldDogVmlld0NvbnRhaW5lclJlZjtcbiAgY29udGVudDogQ29udGVudCA9IHtcbiAgICB0eXBlOiBDb250ZW50VHlwZS5TVFJJTkcsXG4gICAgZGF0YTogJycsXG4gICAgcHJvcHM6IHt9XG4gIH07XG4gIGNvbmZpZzogVG9wcHlDb25maWc7XG4gIHBvc2l0aW9uOiBUb3BweVBvc2l0aW9uO1xuICB0aWQ6IFRJRDtcbiAgZWw6IEhUTUxFbGVtZW50IHwgYW55O1xuICB3cmFwcGVyRWw6IEhUTUxFbGVtZW50IHwgYW55O1xuICBleHRyYTogc3RyaW5nO1xuICBwaW5qOiBhbnk7XG4gIGNvbXBJbnN0YW5jZTtcbiAgcHJpdmF0ZSBkaWU6IFN1YmplY3Q8MT4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBpbmo6IEluamVjdG9yLFxuICAgIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgY29tcFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBlbFJlZjogRWxlbWVudFJlZlxuICApIHtcbiAgICB0aGlzLnBpbmogPSBJbmplY3RvcjtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZWwgPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgdGhpcy53cmFwcGVyRWwgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3IoJy50LXdyYXBwZXInKTtcbiAgICBsZXQgY2xzID0gWyd0LWNvbnRhaW5lcicsIHRoaXMuY29uZmlnLmNvbnRhaW5lckNsYXNzLCB0aGlzLnBvc2l0aW9uLmdldENsYXNzTmFtZSgpXTtcbiAgICBpZiAodGhpcy5jb25maWcuY2xvc2VPbkRvY0NsaWNrKSB7XG4gICAgICBjbHMgPSBjbHMuY29uY2F0KFsnbm8tcG9pbnRlcnMnXSk7XG4gICAgfVxuICAgIHRoaXMuZWwuc2V0QXR0cmlidXRlKCdkYXRhLXRpZCcsIHRoaXMudGlkKTtcbiAgICBjc3NDbGFzcygnYWRkJywgY2xzLCBgW2RhdGEtdGlkPScke1t0aGlzLnRpZF19J11gKTtcbiAgICBjc3NDbGFzcygnYWRkJywgW3RoaXMuY29uZmlnLmJvZHlDbGFzc10pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMubGlzdGVuUG9zKCkuc3Vic2NyaWJlKCk7XG4gICAgaWYgKHRoaXMuY29udGVudC50eXBlID09PSBDb250ZW50VHlwZS5DT01QT05FTlQpIHtcbiAgICAgIHRoaXMuY29tcEluc3RhbmNlID0gdGhpcy5zZXRDb21wb25lbnQodGhpcy5jb250ZW50LnByb3BzKTtcbiAgICAgIEJ1cy5zZW5kKHRoaXMudGlkLCAndF9jb21waW5zJywgdGhpcy5jb21wSW5zdGFuY2UpO1xuICAgIH1cbiAgfVxuXG4gIHNldENvbXBvbmVudChwcm9wcykge1xuICAgIGNvbnN0IGNvbXBSZWYgPSB0aGlzLmNvbXBPdXRsZXQuY3JlYXRlQ29tcG9uZW50KFxuICAgICAgdGhpcy5jb21wUmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGhpcy5jb250ZW50LmRhdGEgYXMgYW55KVxuICAgICk7XG4gICAgT2JqZWN0LmFzc2lnbihjb21wUmVmLmluc3RhbmNlLCBwcm9wcyk7XG4gICAgY29tcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgcmV0dXJuIGNvbXBSZWYuaW5zdGFuY2U7XG4gIH1cblxuICB1cGRhdGVUZXh0Q29udGVudChkYXRhOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb250ZW50LnR5cGUgPT09IENvbnRlbnRUeXBlLlNUUklORykge1xuICAgICAgdGhpcy5jb250ZW50LmRhdGEgPSBkYXRhO1xuICAgICAgdGhpcy5jZC5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgY3NzQ2xhc3MoJ3JlbW92ZScsIFt0aGlzLmNvbmZpZy5ib2R5Q2xhc3NdKTtcbiAgICB0aGlzLmRpZS5uZXh0KDEpO1xuICAgIEJ1cy5zZW5kKHRoaXMudGlkLCAndF9kZXRhY2gnKTtcbiAgfVxuXG4gIHByaXZhdGUgbGlzdGVuUG9zKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIEJ1cy5saXN0ZW4odGhpcy50aWQsICd0X2R5bnBvcycpLnBpcGUoXG4gICAgICBzdGFydFdpdGgoMSksXG4gICAgICB0YWtlVW50aWwodGhpcy5kaWUpLFxuICAgICAgdGFwKGUgPT4ge1xuICAgICAgICBpZiAoIWUgfHwgIWUueCkgcmV0dXJuIHRoaXMuc2V0UG9zKCk7XG4gICAgICAgIGNvbnN0IGNvb3JkcyA9IHsgbGVmdDogZS54LCB0b3A6IGUueSB9O1xuICAgICAgICB0aGlzLndyYXBwZXJFbC5zdHlsZSA9IHRvQ3NzKGNvb3Jkcyk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNldFBvcygpOiB2b2lkIHtcbiAgICBjb25zdCB7IGV4dHJhLCAuLi5jb29yZHMgfSA9IHRoaXMucG9zaXRpb24uZ2V0UG9zaXRpb25zKHRoaXMud3JhcHBlckVsKTtcbiAgICBpZiAodGhpcy5leHRyYSAhPT0gZXh0cmEpIHtcbiAgICAgIHRoaXMuZXh0cmEgPSBleHRyYTtcbiAgICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgICBPYmplY3QuYXNzaWduKGNvb3JkcywgeyB2aXNpYmlsaXR5OiAndmlzaWJsZScsIG9wYWNpdHk6ICcxJyB9KTtcbiAgICB0aGlzLndyYXBwZXJFbC5zdHlsZSA9IHRvQ3NzKGNvb3Jkcyk7XG4gICAgQnVzLnNlbmQodGhpcy50aWQsICd0X3Bvc3VwZGF0ZScpO1xuICB9XG59XG4iXX0=