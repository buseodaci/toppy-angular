/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { OutsidePlacement } from '../models';
import { Bus, setWH } from '../utils';
import { ToppyPosition } from './position';
/**
 * @record
 */
function RelativePositionConfig() { }
if (false) {
    /** @type {?} */
    RelativePositionConfig.prototype.src;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.placement;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.autoUpdate;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.width;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.height;
}
export class RelativePosition extends ToppyPosition {
    /**
     * @param {?} config
     */
    constructor(config) {
        super();
        this.config = {
            src: null,
            placement: OutsidePlacement.TOP,
            autoUpdate: false,
            width: 'auto',
            height: 'auto'
        };
        this.updateConfig(config);
    }
    /**
     * @param {?} tid
     * @return {?}
     */
    init(tid) {
        if (this.config.autoUpdate)
            this.listenDrag(tid);
    }
    /**
     * @param {?} targetEl
     * @return {?}
     */
    getPositions(targetEl) {
        /** @type {?} */
        const s = this.getCoords(this.config.src);
        /** @type {?} */
        const h = this.getCoords(targetEl);
        let { width: w, height: ht } = this.config;
        w = setWH(s, h, 'width', w);
        ht = setWH(s, h, 'height', ht);
        const { pos, props } = this.calculatePos(this.config.placement, s, h);
        return Object.assign({}, this.round(props), { width: w, height: ht, extra: pos });
    }
    /**
     * @private
     * @param {?} elem
     * @return {?}
     */
    getCoords(elem) {
        return elem.getBoundingClientRect();
    }
    /**
     * @private
     * @param {?} placement
     * @param {?} src
     * @param {?} host
     * @return {?}
     */
    calc(placement, src, host) {
        const [main, sub] = placement.split('');
        /** @type {?} */
        const p = { left: 0, top: 0 };
        if ((main === 't' || main === 'b') && !sub) {
            p.left = src.left + (src.width - host.width) / 2;
        }
        if ((main === 't' || main === 'b') && sub) {
            p.left = src.left;
        }
        if ((main === 't' || main === 'b') && sub === 'r') {
            p.left = src.left + src.width - host.width;
        }
        if (main === 'l') {
            p.left = src.left - host.width;
        }
        if (main === 'r') {
            p.left = src.right;
        }
        if (main === 't') {
            p.top = src.top - host.height;
        }
        if (main === 'b') {
            p.top = src.top + src.height;
        }
        if (main === 'l' || main === 'r') {
            p.top = src.top + (src.height - host.height) / 2;
        }
        if (sub === 't' && (main === 'l' || main === 'r')) {
            p.top = src.top;
        }
        if (sub === 'b' && (main === 'l' || main === 'r')) {
            p.top = src.top + src.height - host.height;
        }
        return p;
    }
    /**
     * @private
     * @param {?} pos
     * @param {?} s
     * @param {?} h
     * @param {?=} c
     * @return {?}
     */
    calculatePos(pos, s, h, c = true) {
        /** @type {?} */
        const props = this.calc(pos, s, h);
        if (c && this.config.autoUpdate && this.isOverflowed(Object.assign({}, props, { width: h.width, height: h.height }))) {
            return this.calculatePos(this.nextPosition(pos), s, h, false);
        }
        return { pos, props };
    }
    /**
     * @private
     * @param {?} props
     * @return {?}
     */
    isOverflowed(props) {
        const { innerHeight, innerWidth } = window;
        props.bottom = props.top + props.height;
        props.right = props.left + props.width;
        return props.bottom > innerHeight || props.top <= 0 || props.left <= 0 || props.right > innerWidth;
    }
    /**
     * @private
     * @param {?} current
     * @return {?}
     */
    nextPosition(current) {
        /** @type {?} */
        const placements = ['t', 'b', 'l', 'r', 'tl', 'bl', 'tr', 'br', 'lt', 'rt', 'lb', 'rb'];
        /** @type {?} */
        const index = placements.indexOf(current);
        /** @type {?} */
        const even = index % 2 === 0;
        return even ? placements[index + 1] : placements[index - 1];
    }
    /**
     * @private
     * @param {?} props
     * @return {?}
     */
    round(props) {
        Object.keys(props).forEach(x => (props[x] = Math.round(props[x])));
        return props;
    }
    /**
     * @private
     * @param {?} tid
     * @return {?}
     */
    listenDrag(tid) {
        if (this.obs)
            this.obs.disconnect();
        this.obs = new MutationObserver(mutationsList => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes')
                    Bus.send(tid, 't_dynpos');
            }
        });
        this.obs.observe(this.config.src, {
            attributeFilter: ['style']
        });
    }
}
if (false) {
    /**
     * @type {?}
     * @protected
     */
    RelativePosition.prototype.config;
    /** @type {?} */
    RelativePosition.prototype.obs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpdmUtcG9zaXRpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly90b3BweS8iLCJzb3VyY2VzIjpbImxpYi9wb3NpdGlvbi9yZWxhdGl2ZS1wb3NpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFnQixNQUFNLFdBQVcsQ0FBQztBQUMzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sWUFBWSxDQUFDOzs7O0FBRTNDLHFDQU1DOzs7SUFMQyxxQ0FBaUI7O0lBQ2pCLDJDQUE2Qjs7SUFDN0IsNENBQXFCOztJQUNyQix1Q0FBd0I7O0lBQ3hCLHdDQUF5Qjs7QUFHM0IsTUFBTSxPQUFPLGdCQUFpQixTQUFRLGFBQWE7Ozs7SUFTakQsWUFBWSxNQUE4QjtRQUN4QyxLQUFLLEVBQUUsQ0FBQztRQVRBLFdBQU0sR0FBMkI7WUFDekMsR0FBRyxFQUFFLElBQUk7WUFDVCxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsR0FBRztZQUMvQixVQUFVLEVBQUUsS0FBSztZQUNqQixLQUFLLEVBQUUsTUFBTTtZQUNiLE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQztRQUlBLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUIsQ0FBQzs7Ozs7SUFDRCxJQUFJLENBQUMsR0FBVztRQUNkLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVO1lBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuRCxDQUFDOzs7OztJQUVELFlBQVksQ0FBQyxRQUFxQjs7Y0FDMUIsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7O2NBQ25DLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUM5QixFQUFFLEtBQUssRUFB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Q3BDLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxZQUFZO29CQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQy9EO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUNoQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUM7U0FDM0IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGOzs7Ozs7SUFoSEMsa0NBTUU7O0lBQ0YsK0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3V0c2lkZVBsYWNlbWVudCwgUG9zaXRpb25NZXRhIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IEJ1cywgc2V0V0ggfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBUb3BweVBvc2l0aW9uIH0gZnJvbSAnLi9wb3NpdGlvbic7XG5cbmludGVyZmFjZSBSZWxhdGl2ZVBvc2l0aW9uQ29uZmlnIHtcbiAgc3JjOiBIVE1MRWxlbWVudDtcbiAgcGxhY2VtZW50PzogT3V0c2lkZVBsYWNlbWVudDtcbiAgYXV0b1VwZGF0ZT86IGJvb2xlYW47XG4gIHdpZHRoPzogc3RyaW5nIHwgbnVtYmVyO1xuICBoZWlnaHQ/OiBzdHJpbmcgfCBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBSZWxhdGl2ZVBvc2l0aW9uIGV4dGVuZHMgVG9wcHlQb3NpdGlvbiB7XG4gIHByb3RlY3RlZCBjb25maWc6IFJlbGF0aXZlUG9zaXRpb25Db25maWcgPSB7XG4gICAgc3JjOiBudWxsLFxuICAgIHBsYWNlbWVudDogT3V0c2lkZVBsYWNlbWVudC5UT1AsXG4gICAgYXV0b1VwZGF0ZTogZmFsc2UsXG4gICAgd2lkdGg6ICdhdXRvJyxcbiAgICBoZWlnaHQ6ICdhdXRvJ1xuICB9O1xuICBvYnM6IE11dGF0aW9uT2JzZXJ2ZXI7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUmVsYXRpdmVQb3NpdGlvbkNvbmZpZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51cGRhdGVDb25maWcoY29uZmlnKTtcbiAgfVxuICBpbml0KHRpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmF1dG9VcGRhdGUpIHRoaXMubGlzdGVuRHJhZyh0aWQpO1xuICB9XG5cbiAgZ2V0UG9zaXRpb25zKHRhcmdldEVsOiBIVE1MRWxlbWVudCk6IFBpY2s8UG9zaXRpb25NZXRhLCBhbnk+IHtcbiAgICBjb25zdCBzID0gdGhpcy5nZXRDb29yZHModGhpcy5jb25maWcuc3JjKTtcbiAgICBjb25zdCBoID0gdGhpcy5nZXRDb29yZHModGFyZ2V0RWwpO1xuICAgIGxldCB7IHdpZHRoOiB3LCBoZWlnaHQ6IGh0IH0gPSB0aGlzLmNvbmZpZztcblxuICAgIHcgPSBzZXRXSChzLCBoLCAnd2lkdGgnLCB3KTtcbiAgICBodCA9IHNldFdIKHMsIGgsICdoZWlnaHQnLCBodCk7XG5cbiAgICBjb25zdCB7IHBvcywgcHJvcHMgfSA9IHRoaXMuY2FsY3VsYXRlUG9zKHRoaXMuY29uZmlnLnBsYWNlbWVudCwgcywgaCk7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5yb3VuZChwcm9wcyksIHdpZHRoOiB3LCBoZWlnaHQ6IGh0LCBleHRyYTogcG9zIH07XG4gIH1cblxuICBwcml2YXRlIGdldENvb3JkcyhlbGVtOiBIVE1MRWxlbWVudCk6IFBvc2l0aW9uTWV0YSB7XG4gICAgcmV0dXJuIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIH1cblxuICBwcml2YXRlIGNhbGMocGxhY2VtZW50OiBPdXRzaWRlUGxhY2VtZW50LCBzcmMsIGhvc3QpOiBvYmplY3Qge1xuICAgIGNvbnN0IFttYWluLCBzdWJdID0gcGxhY2VtZW50LnNwbGl0KCcnKTtcbiAgICBjb25zdCBwID0geyBsZWZ0OiAwLCB0b3A6IDAgfTtcbiAgICBpZiAoKG1haW4gPT09ICd0JyB8fCBtYWluID09PSAnYicpICYmICFzdWIpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0ICsgKHNyYy53aWR0aCAtIGhvc3Qud2lkdGgpIC8gMjtcbiAgICB9XG5cbiAgICBpZiAoKG1haW4gPT09ICd0JyB8fCBtYWluID09PSAnYicpICYmIHN1Yikge1xuICAgICAgcC5sZWZ0ID0gc3JjLmxlZnQ7XG4gICAgfVxuICAgIGlmICgobWFpbiA9PT0gJ3QnIHx8IG1haW4gPT09ICdiJykgJiYgc3ViID09PSAncicpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0ICsgc3JjLndpZHRoIC0gaG9zdC53aWR0aDtcbiAgICB9XG4gICAgaWYgKG1haW4gPT09ICdsJykge1xuICAgICAgcC5sZWZ0ID0gc3JjLmxlZnQgLSBob3N0LndpZHRoO1xuICAgIH1cbiAgICBpZiAobWFpbiA9PT0gJ3InKSB7XG4gICAgICBwLmxlZnQgPSBzcmMucmlnaHQ7XG4gICAgfVxuXG4gICAgaWYgKG1haW4gPT09ICd0Jykge1xuICAgICAgcC50b3AgPSBzcmMudG9wIC0gaG9zdC5oZWlnaHQ7XG4gICAgfVxuICAgIGlmIChtYWluID09PSAnYicpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcCArIHNyYy5oZWlnaHQ7XG4gICAgfVxuICAgIGlmIChtYWluID09PSAnbCcgfHwgbWFpbiA9PT0gJ3InKSB7XG4gICAgICBwLnRvcCA9IHNyYy50b3AgKyAoc3JjLmhlaWdodCAtIGhvc3QuaGVpZ2h0KSAvIDI7XG4gICAgfVxuICAgIGlmIChzdWIgPT09ICd0JyAmJiAobWFpbiA9PT0gJ2wnIHx8IG1haW4gPT09ICdyJykpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcDtcbiAgICB9XG4gICAgaWYgKHN1YiA9PT0gJ2InICYmIChtYWluID09PSAnbCcgfHwgbWFpbiA9PT0gJ3InKSkge1xuICAgICAgcC50b3AgPSBzcmMudG9wICsgc3JjLmhlaWdodCAtIGhvc3QuaGVpZ2h0O1xuICAgIH1cbiAgICByZXR1cm4gcDtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlUG9zKHBvcywgcywgaCwgYyA9IHRydWUpOiB7IFt4OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLmNhbGMocG9zLCBzLCBoKTtcblxuICAgIGlmIChjICYmIHRoaXMuY29uZmlnLmF1dG9VcGRhdGUgJiYgdGhpcy5pc092ZXJmbG93ZWQoeyAuLi5wcm9wcywgd2lkdGg6IGgud2lkdGgsIGhlaWdodDogaC5oZWlnaHQgfSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhbGN1bGF0ZVBvcyh0aGlzLm5leHRQb3NpdGlvbihwb3MpLCBzLCBoLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcG9zLCBwcm9wcyB9O1xuICB9XG5cbiAgcHJpdmF0ZSBpc092ZXJmbG93ZWQocHJvcHM6IHsgW3g6IHN0cmluZ106IGFueSB9KTogYm9vbGVhbiB7XG4gICAgY29uc3QgeyBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCB9ID0gd2luZG93O1xuICAgIHByb3BzLmJvdHRvbSA9IHByb3BzLnRvcCArIHByb3BzLmhlaWdodDtcbiAgICBwcm9wcy5yaWdodCA9IHByb3BzLmxlZnQgKyBwcm9wcy53aWR0aDtcbiAgICByZXR1cm4gcHJvcHMuYm90dG9tID4gaW5uZXJIZWlnaHQgfHwgcHJvcHMudG9wIDw9IDAgfHwgcHJvcHMubGVmdCA8PSAwIHx8IHByb3BzLnJpZ2h0ID4gaW5uZXJXaWR0aDtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dFBvc2l0aW9uKGN1cnJlbnQ6IE91dHNpZGVQbGFjZW1lbnQpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBsYWNlbWVudHMgPSBbJ3QnLCAnYicsICdsJywgJ3InLCAndGwnLCAnYmwnLCAndHInLCAnYnInLCAnbHQnLCAncnQnLCAnbGInLCAncmInXTtcblxuICAgIGNvbnN0IGluZGV4ID0gcGxhY2VtZW50cy5pbmRleE9mKGN1cnJlbnQpO1xuICAgIGNvbnN0IGV2ZW4gPSBpbmRleCAlIDIgPT09IDA7XG4gICAgcmV0dXJuIGV2ZW4gPyBwbGFjZW1lbnRzW2luZGV4ICsgMV0gOiBwbGFjZW1lbnRzW2luZGV4IC0gMV07XG4gIH1cblxuICBwcml2YXRlIHJvdW5kKHByb3BzOiBvYmplY3QpOiBvYmplY3Qge1xuICAgIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKHggPT4gKHByb3BzW3hdID0gTWF0aC5yb3VuZChwcm9wc1t4XSkpKTtcbiAgICByZXR1cm4gcHJvcHM7XG4gIH1cblxuICBwcml2YXRlIGxpc3RlbkRyYWcodGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vYnMpIHRoaXMub2JzLmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLm9icyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKG11dGF0aW9uc0xpc3QgPT4ge1xuICAgICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbnNMaXN0KSB7XG4gICAgICAgIGlmIChtdXRhdGlvbi50eXBlID09PSAnYXR0cmlidXRlcycpIEJ1cy5zZW5kKHRpZCwgJ3RfZHlucG9zJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLm9icy5vYnNlcnZlKHRoaXMuY29uZmlnLnNyYywge1xuICAgICAgYXR0cmlidXRlRmlsdGVyOiBbJ3N0eWxlJ11cbiAgICB9KTtcbiAgfVxufVxuIl19