/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { animationFrameScheduler, fromEvent, merge as mergeObs, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, filter, map, observeOn, skipWhile, takeUntil, tap } from 'rxjs/operators';
import { ToppyComponent } from './toppy.component';
import { BodyEl, Bus, getContent } from './utils';
export class ToppyControl {
    /**
     * @param {?} appRef
     * @param {?} compResolver
     * @param {?} injector
     */
    constructor(appRef, compResolver, injector) {
        this.appRef = appRef;
        this.compResolver = compResolver;
        this.injector = injector;
        this.updateTextContent = new Subject();
        this.isOpen = false;
        this.die = new Subject();
        this.updateTextContent.subscribe(content => {
            if (this.isOpen)
                this.comp.updateTextContent(content);
        });
    }
    /**
     * @return {?}
     */
    open() {
        if (this.isOpen)
            return;
        this.attach();
        if (this.viewEl) {
            mergeObs(this.onDocumentClick(), this.onWindowResize(), this.onEscClick()).subscribe();
            setTimeout(() => Bus.send(this.tid, 't_dynpos'), 1);
        }
        Bus.send(this.tid, 't_open');
        this.isOpen = true;
    }
    /**
     * @return {?}
     */
    close() {
        if (!this.isOpen)
            return;
        this.dettach();
        this.die.next(1);
        Bus.send(this.tid, 't_close');
        this.isOpen = false;
    }
    /**
     * @return {?}
     */
    toggle() {
        return this.isOpen ? this.close() : this.open();
    }
    /**
     * @return {?}
     */
    onEscClick() {
        return fromEvent(BodyEl, 'keydown').pipe(takeUntil(this.die), skipWhile(() => !this.config.closeOnEsc), filter((e) => (e.key === 'Escape' || e.key === 'Esc' || e.keyCode === 27) && e.target.nodeName === 'BODY'), tap(e => e.preventDefault()), map(e => e.target), tap(() => this.close()));
    }
    /**
     * @return {?}
     */
    onDocumentClick() {
        return fromEvent(this.viewEl, 'click').pipe(takeUntil(this.die), map((e) => e.target), skipWhile(() => !this.config.closeOnDocClick), filter(this.isNotHostElement.bind(this)), tap(() => {
            this.config.docClickCallback();
            this.close();
        }));
    }
    /**
     * @return {?}
     */
    onWindowResize() {
        /** @type {?} */
        const onResize = fromEvent(window, 'resize');
        /** @type {?} */
        const onScroll = fromEvent(window, 'scroll', { passive: true });
        return mergeObs(onResize, onScroll).pipe(skipWhile(() => !this.config.listenWindowEvents), takeUntil(this.die), debounceTime(5), observeOn(animationFrameScheduler), distinctUntilChanged(), tap(() => {
            Bus.send(this.tid, 't_dynpos');
            this.config.windowResizeCallback();
        }));
    }
    /**
     * @param {?} newPosition
     * @return {?}
     */
    changePosition(newPosition) {
        this.position = newPosition;
    }
    /**
     * @param {?} positionConfig
     * @return {?}
     */
    updatePosition(positionConfig) {
        this.position.updateConfig(positionConfig);
    }
    /**
     * @param {?} content
     * @param {?=} props
     * @return {?}
     */
    updateContent(content, props = {}) {
        this.content = getContent(content, Object.assign({}, this.content.props, props));
    }
    /**
     * @param {?} eventName
     * @return {?}
     */
    listen(eventName) {
        return Bus.listen(this.tid, eventName);
    }
    /**
     * @private
     * @param {?} el
     * @return {?}
     */
    isNotHostElement(el) {
        /** @type {?} */
        const wrapperEl = this.viewEl.querySelector('.t-wrapper');
        return el !== wrapperEl && !wrapperEl.contains(el);
    }
    /**
     * @private
     * @return {?}
     */
    attach() {
        /* create component */
        this.compFac = this.compResolver.resolveComponentFactory(ToppyComponent);
        this.compRef = this.compFac.create(this.injector);
        this.comp = this.compRef.instance;
        /* assign props */
        const { position, content, config, tid } = this;
        content.props.close = this.close.bind(this);
        Object.assign(this.comp, { position, content, config, tid });
        /* attach view */
        this.hostView = this.compRef.hostView;
        this.appRef.attachView(this.hostView);
        this.viewEl = ((/** @type {?} */ (this.hostView))).rootNodes[0];
        BodyEl.appendChild(this.viewEl);
    }
    /**
     * @private
     * @return {?}
     */
    dettach() {
        if (!this.hostView)
            return;
        this.appRef.detachView(this.hostView);
        this.compRef.destroy();
        this.hostView = this.viewEl = this.comp = null;
    }
}
if (false) {
    /** @type {?} */
    ToppyControl.prototype.position;
    /** @type {?} */
    ToppyControl.prototype.config;
    /** @type {?} */
    ToppyControl.prototype.content;
    /** @type {?} */
    ToppyControl.prototype.tid;
    /** @type {?} */
    ToppyControl.prototype.comp;
    /** @type {?} */
    ToppyControl.prototype.updateTextContent;
    /** @type {?} */
    ToppyControl.prototype.hostView;
    /** @type {?} */
    ToppyControl.prototype.compRef;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.viewEl;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.isOpen;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.compFac;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.die;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.appRef;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.compResolver;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wcHktY29udHJvbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3RvcHB5LyIsInNvdXJjZXMiOlsibGliL3RvcHB5LWNvbnRyb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVFBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsS0FBSyxJQUFJLFFBQVEsRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEcsT0FBTyxFQUFFLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3ZILE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFbEQsTUFBTSxPQUFPLFlBQVk7Ozs7OztJQWV2QixZQUNVLE1BQXNCLEVBQ3RCLFlBQXNDLEVBQ3RDLFFBQWtCO1FBRmxCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBQ3RCLGlCQUFZLEdBQVosWUFBWSxDQUEwQjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBWjVCLHNCQUFpQixHQUFvQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBSzNDLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFFZixRQUFHLEdBQWUsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQU90QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU07Z0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7SUFFRCxJQUFJO1FBQ0YsSUFBSSxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU87UUFFeEIsSUFBSSxD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QUFDLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUUzQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDakQsQ0FBQztDQUNGOzs7SUF4SUMsZ0NBQXdCOztJQUN4Qiw4QkFBb0I7O0lBQ3BCLCtCQUFpQjs7SUFDakIsMkJBQVM7O0lBQ1QsNEJBQXFCOztJQUNyQix5Q0FBbUQ7O0lBQ25ELGdDQUFrQjs7SUFDbEIsK0JBQXNDOzs7OztJQUV0Qyw4QkFBNEI7Ozs7O0lBQzVCLDhCQUF1Qjs7Ozs7SUFDdkIsK0JBQWtEOzs7OztJQUNsRCwyQkFBd0M7Ozs7O0lBR3RDLDhCQUE4Qjs7Ozs7SUFDOUIsb0NBQThDOzs7OztJQUM5QyxnQ0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBcHBsaWNhdGlvblJlZixcbiAgQ29tcG9uZW50RmFjdG9yeSxcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIEluamVjdG9yLFxuICBWaWV3UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIsIGZyb21FdmVudCwgbWVyZ2UgYXMgbWVyZ2VPYnMsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBvYnNlcnZlT24sIHNraXBXaGlsZSwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb250ZW50LCBDb250ZW50RGF0YSwgQ29udGVudFByb3BzLCBUSUQsIFRvcHB5Q29uZmlnLCBUb3BweUV2ZW50TmFtZSB9IGZyb20gJy4vbW9kZWxzJztcbmltcG9ydCB7IFRvcHB5UG9zaXRpb24gfSBmcm9tICcuL3Bvc2l0aW9uL3Bvc2l0aW9uJztcbmltcG9ydCB7IFRvcHB5Q29tcG9uZW50IH0gZnJvbSAnLi90b3BweS5jb21wb25lbnQnO1xuaW1wb3J0IHsgQm9keUVsLCBCdXMsIGdldENvbnRlbnQgfSBmcm9tICcuL3V0aWxzJztcblxuZXhwb3J0IGNsYXNzIFRvcHB5Q29udHJvbCB7XG4gIHBvc2l0aW9uOiBUb3BweVBvc2l0aW9uO1xuICBjb25maWc6IFRvcHB5Q29uZmlnO1xuICBjb250ZW50OiBDb250ZW50O1xuICB0aWQ6IFRJRDtcbiAgY29tcDogVG9wcHlDb21wb25lbnQ7XG4gIHVwZGF0ZVRleHRDb250ZW50OiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdCgpO1xuICBob3N0VmlldzogVmlld1JlZjtcbiAgY29tcFJlZjogQ29tcG9uZW50UmVmPFRvcHB5Q29tcG9uZW50PjtcblxuICBwcml2YXRlIHZpZXdFbDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgaXNPcGVuID0gZmFsc2U7XG4gIHByaXZhdGUgY29tcEZhYzogQ29tcG9uZW50RmFjdG9yeTxUb3BweUNvbXBvbmVudD47XG4gIHByaXZhdGUgZGllOiBTdWJqZWN0PDE+ID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgcHJpdmF0ZSBjb21wUmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxuICApIHtcbiAgICB0aGlzLnVwZGF0ZVRleHRDb250ZW50LnN1YnNjcmliZShjb250ZW50ID0+IHtcbiAgICAgIGlmICh0aGlzLmlzT3BlbikgdGhpcy5jb21wLnVwZGF0ZVRleHRDb250ZW50KGNvbnRlbnQpO1xuICAgIH0pO1xuICB9XG5cbiAgb3BlbigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc09wZW4pIHJldHVybjtcblxuICAgIHRoaXMuYXR0YWNoKCk7XG4gICAgaWYgKHRoaXMudmlld0VsKSB7XG4gICAgICBtZXJnZU9icyh0aGlzLm9uRG9jdW1lbnRDbGljaygpLCB0aGlzLm9uV2luZG93UmVzaXplKCksIHRoaXMub25Fc2NDbGljaygpKS5zdWJzY3JpYmUoKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gQnVzLnNlbmQodGhpcy50aWQsICd0X2R5bnBvcycpLCAxKTtcbiAgICB9XG5cbiAgICBCdXMuc2VuZCh0aGlzLnRpZCwgJ3Rfb3BlbicpO1xuICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTtcbiAgfVxuXG4gIGNsb3NlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pc09wZW4pIHJldHVybjtcblxuICAgIHRoaXMuZGV0dGFjaCgpO1xuICAgIHRoaXMuZGllLm5leHQoMSk7XG4gICAgQnVzLnNlbmQodGhpcy50aWQsICd0X2Nsb3NlJyk7XG4gICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgfVxuXG4gIHRvZ2dsZSgpOiB2b2lkIHtcbiAgICByZXR1cm4gdGhpcy5pc09wZW4gPyB0aGlzLmNsb3NlKCkgOiB0aGlzLm9wZW4oKTtcbiAgfVxuXG4gIG9uRXNjQ2xpY2soKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gZnJvbUV2ZW50KEJvZHlFbCwgJ2tleWRvd24nKS5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMuZGllKSxcbiAgICAgIHNraXBXaGlsZSgoKSA9PiAhdGhpcy5jb25maWcuY2xvc2VPbkVzYyksXG4gICAgICBmaWx0ZXIoKGU6IGFueSkgPT4gKGUua2V5ID09PSAnRXNjYXBlJyB8fCBlLmtleSA9PT0gJ0VzYycgfHwgZS5rZXlDb2RlID09PSAyNykgJiYgZS50YXJnZXQubm9kZU5hbWUgPT09ICdCT0RZJyksXG4gICAgICB0YXAoZSA9PiBlLnByZXZlbnREZWZhdWx0KCkpLFxuICAgICAgbWFwKGUgPT4gZS50YXJnZXQpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuY2xvc2UoKSlcbiAgICApO1xuICB9XG5cbiAgb25Eb2N1bWVudENsaWNrKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGZyb21FdmVudCh0aGlzLnZpZXdFbCwgJ2NsaWNrJykucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRpZSksXG4gICAgICBtYXAoKGU6IGFueSkgPT4gZS50YXJnZXQpLFxuICAgICAgc2tpcFdoaWxlKCgpID0+ICF0aGlzLmNvbmZpZy5jbG9zZU9uRG9jQ2xpY2spLFxuICAgICAgZmlsdGVyKHRoaXMuaXNOb3RIb3N0RWxlbWVudC5iaW5kKHRoaXMpKSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMuY29uZmlnLmRvY0NsaWNrQ2FsbGJhY2soKTtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgb25XaW5kb3dSZXNpemUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBvblJlc2l6ZSA9IGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnKTtcbiAgICBjb25zdCBvblNjcm9sbCA9IGZyb21FdmVudCh3aW5kb3csICdzY3JvbGwnLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gICAgcmV0dXJuIG1lcmdlT2JzKG9uUmVzaXplLCBvblNjcm9sbCkucGlwZShcbiAgICAgIHNraXBXaGlsZSgoKSA9PiAhdGhpcy5jb25maWcubGlzdGVuV2luZG93RXZlbnRzKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRpZSksXG4gICAgICBkZWJvdW5jZVRpbWUoNSksXG4gICAgICBvYnNlcnZlT24oYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIEJ1cy5zZW5kKHRoaXMudGlkLCAndF9keW5wb3MnKTtcbiAgICAgICAgdGhpcy5jb25maWcud2luZG93UmVzaXplQ2FsbGJhY2soKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGNoYW5nZVBvc2l0aW9uKG5ld1Bvc2l0aW9uOiBUb3BweVBvc2l0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5wb3NpdGlvbiA9IG5ld1Bvc2l0aW9uO1xuICB9XG5cbiAgdXBkYXRlUG9zaXRpb24ocG9zaXRpb25Db25maWc6IGFueSk6IHZvaWQge1xuICAgIHRoaXMucG9zaXRpb24udXBkYXRlQ29uZmlnKHBvc2l0aW9uQ29uZmlnKTtcbiAgfVxuXG4gIHVwZGF0ZUNvbnRlbnQoY29udGVudDogQ29udGVudERhdGEsIHByb3BzOiBDb250ZW50UHJvcHMgPSB7fSk6IHZvaWQge1xuICAgIHRoaXMuY29udGVudCA9IGdldENvbnRlbnQoY29udGVudCwgeyAuLi50aGlzLmNvbnRlbnQucHJvcHMsIC4uLnByb3BzIH0pO1xuICB9XG5cbiAgbGlzdGVuKGV2ZW50TmFtZTogVG9wcHlFdmVudE5hbWUpIHtcbiAgICByZXR1cm4gQnVzLmxpc3Rlbih0aGlzLnRpZCwgZXZlbnROYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNOb3RIb3N0RWxlbWVudChlbCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHdyYXBwZXJFbCA9IHRoaXMudmlld0VsLnF1ZXJ5U2VsZWN0b3IoJy50LXdyYXBwZXInKTtcbiAgICByZXR1cm4gZWwgIT09IHdyYXBwZXJFbCAmJiAhd3JhcHBlckVsLmNvbnRhaW5zKGVsKTtcbiAgfVxuXG4gIHByaXZhdGUgYXR0YWNoKCk6IHZvaWQge1xuICAgIC8qIGNyZWF0ZSBjb21wb25lbnQgKi9cbiAgICB0aGlzLmNvbXBGYWMgPSB0aGlzLmNvbXBSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShUb3BweUNvbXBvbmVudCk7XG4gICAgdGhpcy5jb21wUmVmID0gdGhpcy5jb21wRmFjLmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcbiAgICB0aGlzLmNvbXAgPSB0aGlzLmNvbXBSZWYuaW5zdGFuY2U7XG5cbiAgICAvKiBhc3NpZ24gcHJvcHMgKi9cbiAgICBjb25zdCB7IHBvc2l0aW9uLCBjb250ZW50LCBjb25maWcsIHRpZCB9ID0gdGhpcztcbiAgICBjb250ZW50LnByb3BzLmNsb3NlID0gdGhpcy5jbG9zZS5iaW5kKHRoaXMpO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcy5jb21wLCB7IHBvc2l0aW9uLCBjb250ZW50LCBjb25maWcsIHRpZCB9KTtcblxuICAgIC8qIGF0dGFjaCB2aWV3ICovXG4gICAgdGhpcy5ob3N0VmlldyA9IHRoaXMuY29tcFJlZi5ob3N0VmlldztcbiAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KHRoaXMuaG9zdFZpZXcpO1xuICAgIHRoaXMudmlld0VsID0gKHRoaXMuaG9zdFZpZXcgYXMgYW55KS5yb290Tm9kZXNbMF07XG4gICAgQm9keUVsLmFwcGVuZENoaWxkKHRoaXMudmlld0VsKTtcbiAgfVxuXG4gIHByaXZhdGUgZGV0dGFjaCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaG9zdFZpZXcpIHJldHVybjtcblxuICAgIHRoaXMuYXBwUmVmLmRldGFjaFZpZXcodGhpcy5ob3N0Vmlldyk7XG4gICAgdGhpcy5jb21wUmVmLmRlc3Ryb3koKTtcbiAgICB0aGlzLmhvc3RWaWV3ID0gdGhpcy52aWV3RWwgPSB0aGlzLmNvbXAgPSBudWxsO1xuICB9XG59XG4iXX0=