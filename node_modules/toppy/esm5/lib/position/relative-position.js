/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { OutsidePlacement } from '../models';
import { Bus, setWH } from '../utils';
import { ToppyPosition } from './position';
/**
 * @record
 */
function RelativePositionConfig() { }
if (false) {
    /** @type {?} */
    RelativePositionConfig.prototype.src;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.placement;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.autoUpdate;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.width;
    /** @type {?|undefined} */
    RelativePositionConfig.prototype.height;
}
var RelativePosition = /** @class */ (function (_super) {
    tslib_1.__extends(RelativePosition, _super);
    function RelativePosition(config) {
        var _this = _super.call(this) || this;
        _this.config = {
            src: null,
            placement: OutsidePlacement.TOP,
            autoUpdate: false,
            width: 'auto',
            height: 'auto'
        };
        _this.updateConfig(config);
        return _this;
    }
    /**
     * @param {?} tid
     * @return {?}
     */
    RelativePosition.prototype.init = /**
     * @param {?} tid
     * @return {?}
     */
    function (tid) {
        if (this.config.autoUpdate)
            this.listenDrag(tid);
    };
    /**
     * @param {?} targetEl
     * @return {?}
     */
    RelativePosition.prototype.getPositions = /**
     * @param {?} targetEl
     * @return {?}
     */
    function (targetEl) {
        /** @type {?} */
        var s = this.getCoords(this.config.src);
        /** @type {?} */
        var h = this.getCoords(targetEl);
        var _a = this.config, w = _a.width, ht = _a.height;
        w = setWH(s, h, 'width', w);
        ht = setWH(s, h, 'height', ht);
        var _b = this.calculatePos(this.config.placement, s, h), pos = _b.pos, props = _b.props;
        return tslib_1.__assign({}, this.round(props), { width: w, height: ht, extra: pos });
    };
    /**
     * @private
     * @param {?} elem
     * @return {?}
     */
    RelativePosition.prototype.getCoords = /**
     * @private
     * @param {?} elem
     * @return {?}
     */
    function (elem) {
        return elem.getBoundingClientRect();
    };
    /**
     * @private
     * @param {?} placement
     * @param {?} src
     * @param {?} host
     * @return {?}
     */
    RelativePosition.prototype.calc = /**
     * @private
     * @param {?} placement
     * @param {?} src
     * @param {?} host
     * @return {?}
     */
    function (placement, src, host) {
        var _a = tslib_1.__read(placement.split(''), 2), main = _a[0], sub = _a[1];
        /** @type {?} */
        var p = { left: 0, top: 0 };
        if ((main === 't' || main === 'b') && !sub) {
            p.left = src.left + (src.width - host.width) / 2;
        }
        if ((main === 't' || main === 'b') && sub) {
            p.left = src.left;
        }
        if ((main === 't' || main === 'b') && sub === 'r') {
            p.left = src.left + src.width - host.width;
        }
        if (main === 'l') {
            p.left = src.left - host.width;
        }
        if (main === 'r') {
            p.left = src.right;
        }
        if (main === 't') {
            p.top = src.top - host.height;
        }
        if (main === 'b') {
            p.top = src.top + src.height;
        }
        if (main === 'l' || main === 'r') {
            p.top = src.top + (src.height - host.height) / 2;
        }
        if (sub === 't' && (main === 'l' || main === 'r')) {
            p.top = src.top;
        }
        if (sub === 'b' && (main === 'l' || main === 'r')) {
            p.top = src.top + src.height - host.height;
        }
        return p;
    };
    /**
     * @private
     * @param {?} pos
     * @param {?} s
     * @param {?} h
     * @param {?=} c
     * @return {?}
     */
    RelativePosition.prototype.calculatePos = /**
     * @private
     * @param {?} pos
     * @param {?} s
     * @param {?} h
     * @param {?=} c
     * @return {?}
     */
    function (pos, s, h, c) {
        if (c === void 0) { c = true; }
        /** @type {?} */
        var props = this.calc(pos, s, h);
        if (c && this.config.autoUpdate && this.isOverflowed(tslib_1.__assign({}, props, { width: h.width, height: h.height }))) {
            return this.calculatePos(this.nextPosition(pos), s, h, false);
        }
        return { pos: pos, props: props };
    };
    /**
     * @private
     * @param {?} props
     * @return {?}
     */
    RelativePosition.prototype.isOverflowed = /**
     * @private
     * @param {?} props
     * @return {?}
     */
    function (props) {
        var innerHeight = window.innerHeight, innerWidth = window.innerWidth;
        props.bottom = props.top + props.height;
        props.right = props.left + props.width;
        return props.bottom > innerHeight || props.top <= 0 || props.left <= 0 || props.right > innerWidth;
    };
    /**
     * @private
     * @param {?} current
     * @return {?}
     */
    RelativePosition.prototype.nextPosition = /**
     * @private
     * @param {?} current
     * @return {?}
     */
    function (current) {
        /** @type {?} */
        var placements = ['t', 'b', 'l', 'r', 'tl', 'bl', 'tr', 'br', 'lt', 'rt', 'lb', 'rb'];
        /** @type {?} */
        var index = placements.indexOf(current);
        /** @type {?} */
        var even = index % 2 === 0;
        return even ? placements[index + 1] : placements[index - 1];
    };
    /**
     * @private
     * @param {?} props
     * @return {?}
     */
    RelativePosition.prototype.round = /**
     * @private
     * @param {?} props
     * @return {?}
     */
    function (props) {
        Object.keys(props).forEach(function (x) { return (props[x] = Math.round(props[x])); });
        return props;
    };
    /**
     * @private
     * @param {?} tid
     * @return {?}
     */
    RelativePosition.prototype.listenDrag = /**
     * @private
     * @param {?} tid
     * @return {?}
     */
    function (tid) {
        if (this.obs)
            this.obs.disconnect();
        this.obs = new MutationObserver(function (mutationsList) {
            var e_1, _a;
            try {
                for (var mutationsList_1 = tslib_1.__values(mutationsList), mutationsList_1_1 = mutationsList_1.next(); !mutationsList_1_1.done; mutationsList_1_1 = mutationsList_1.next()) {
                    var mutation = mutationsList_1_1.value;
                    if (mutation.type === 'attributes')
                        Bus.send(tid, 't_dynpos');
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (mutationsList_1_1 && !mutationsList_1_1.done && (_a = mutationsList_1.return)) _a.call(mutationsList_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        this.obs.observe(this.config.src, {
            attributeFilter: ['style']
        });
    };
    return RelativePosition;
}(ToppyPosition));
export { RelativePosition };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    RelativePosition.prototype.config;
    /** @type {?} */
    RelativePosition.prototype.obs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpdmUtcG9zaXRpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly90b3BweS8iLCJzb3VyY2VzIjpbImxpYi9wb3NpdGlvbi9yZWxhdGl2ZS1wb3NpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBZ0IsTUFBTSxXQUFXLENBQUM7QUFDM0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFlBQVksQ0FBQzs7OztBQUUzQyxxQ0FNQzs7O0lBTEMscUNBQWlCOztJQUNqQiwyQ0FBNkI7O0lBQzdCLDRDQUFxQjs7SUFDckIsdUNBQXdCOztJQUN4Qix3Q0FBeUI7O0FBRzNCO0lBQXNDLDRDQUFhO0lBU2pELDBCQUFZLE1BQThCO1FBQTFDLFlBQ0UsaUJBQU8sU0FFUjtRQVhTLFlBQU0sR0FBMkI7WUFDekMsR0FBRyxFQUFFLElBQUk7WUFDVCxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsR0FBRztZQUMvQixVQUFVLEVBQUUsS0FBSztZQUNqQixLQUFLLEVBQUUsTUFBTTtZQUNiLE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQztRQUlBLEtBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7O0lBQzVCLENBQUM7Ozs7O0lBQ0QsK0JBQUk7Ozs7SUFBSixVQUFLLEdBQVc7UUFDZCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVTtZQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkQsQ0FBQzs7Ozs7SUFFRCx1Q0FBWTs7OztJQUFaLFVBQWEsUUFBcUI7O1lBQzFCLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDOztZQUNuQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFDOUIsSUFBQSxnQkFBc0MsRUFBcEMsWUFBUSxFQUFFLGNBQTBCO1FBRTFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDNUIsRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV6QixJQUFBLG1EQUErRCxFQUE3RCxZQUFHLEVBQUUsZ0JBQXdEO1FBQ3JFLDRCQUFZLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUc7SUFDcEUsQ0FBQzs7Ozs7O0lBRU8sb0NBQVM7Ozs7O0lBQWpCLFVBQWtCLElBQWlCO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDdEMsQ0FBQzs7Ozs7Ozs7SUFFTywrQkFBSTs7Ozs7OztJQUFaLFVBQWEsU0FBMkIsRUFBRSxHQUFHLEVBQUUsSUFBSTtRQUMzQyxJQUFBLDJDQUFpQyxFQUFoQyxZQUFJLEVBQUUsV0FBMEI7O1lBQ2pDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUM3QixJQUFJLENBQUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDMUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxLQUFLLEdBQUcsQ0FBQyxJQUFJLEdBQUcsRUFBRTtZQUN6QyxDQUFDLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7U0FDbkI7UUFDRCxJQUFJLENBQUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksR0FBRyxLQUFLLEdBQUcsRUFBRTtZQUNqRCxDQUFDLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQzVDO1FBQ0QsSUFBSSxJQUFJLEtBQUssR0FBRyxFQUFFO1lBQ2hCLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQ2hDO1FBQ0QsSUFBSSxJQUFJLEtBQUssR0FBRyxFQUFFO1lBQ2hCLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztTQUNwQjtRQUVELElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRTtZQUNoQixDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUMvQjtRQUNELElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRTtZQUNoQixDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztTQUM5QjtRQUNELElBQUksSUFBSSxLQUFLLEdBQUcsSUFBSSxJQUFJLEtBQUssR0FBRyxFQUFFO1lBQ2hDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNsRDtRQUNELElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFO1lBQ2pELENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztTQUNqQjtRQUNELElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxL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QWpDLElBQU0sUUFBUSwwQkFBQTtvQkFDakIsSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLFlBQVk7d0JBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7aUJBQy9EOzs7Ozs7Ozs7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ2hDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQztTQUMzQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsdUJBQUM7QUFBRCxDQUFDLEFBakhELENBQXNDLGFBQWEsR0FpSGxEOzs7Ozs7O0lBaEhDLGtDQU1FOztJQUNGLCtCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE91dHNpZGVQbGFjZW1lbnQsIFBvc2l0aW9uTWV0YSB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBCdXMsIHNldFdIIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgVG9wcHlQb3NpdGlvbiB9IGZyb20gJy4vcG9zaXRpb24nO1xuXG5pbnRlcmZhY2UgUmVsYXRpdmVQb3NpdGlvbkNvbmZpZyB7XG4gIHNyYzogSFRNTEVsZW1lbnQ7XG4gIHBsYWNlbWVudD86IE91dHNpZGVQbGFjZW1lbnQ7XG4gIGF1dG9VcGRhdGU/OiBib29sZWFuO1xuICB3aWR0aD86IHN0cmluZyB8IG51bWJlcjtcbiAgaGVpZ2h0Pzogc3RyaW5nIHwgbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgUmVsYXRpdmVQb3NpdGlvbiBleHRlbmRzIFRvcHB5UG9zaXRpb24ge1xuICBwcm90ZWN0ZWQgY29uZmlnOiBSZWxhdGl2ZVBvc2l0aW9uQ29uZmlnID0ge1xuICAgIHNyYzogbnVsbCxcbiAgICBwbGFjZW1lbnQ6IE91dHNpZGVQbGFjZW1lbnQuVE9QLFxuICAgIGF1dG9VcGRhdGU6IGZhbHNlLFxuICAgIHdpZHRoOiAnYXV0bycsXG4gICAgaGVpZ2h0OiAnYXV0bydcbiAgfTtcbiAgb2JzOiBNdXRhdGlvbk9ic2VydmVyO1xuICBjb25zdHJ1Y3Rvcihjb25maWc6IFJlbGF0aXZlUG9zaXRpb25Db25maWcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudXBkYXRlQ29uZmlnKGNvbmZpZyk7XG4gIH1cbiAgaW5pdCh0aWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbmZpZy5hdXRvVXBkYXRlKSB0aGlzLmxpc3RlbkRyYWcodGlkKTtcbiAgfVxuXG4gIGdldFBvc2l0aW9ucyh0YXJnZXRFbDogSFRNTEVsZW1lbnQpOiBQaWNrPFBvc2l0aW9uTWV0YSwgYW55PiB7XG4gICAgY29uc3QgcyA9IHRoaXMuZ2V0Q29vcmRzKHRoaXMuY29uZmlnLnNyYyk7XG4gICAgY29uc3QgaCA9IHRoaXMuZ2V0Q29vcmRzKHRhcmdldEVsKTtcbiAgICBsZXQgeyB3aWR0aDogdywgaGVpZ2h0OiBodCB9ID0gdGhpcy5jb25maWc7XG5cbiAgICB3ID0gc2V0V0gocywgaCwgJ3dpZHRoJywgdyk7XG4gICAgaHQgPSBzZXRXSChzLCBoLCAnaGVpZ2h0JywgaHQpO1xuXG4gICAgY29uc3QgeyBwb3MsIHByb3BzIH0gPSB0aGlzLmNhbGN1bGF0ZVBvcyh0aGlzLmNvbmZpZy5wbGFjZW1lbnQsIHMsIGgpO1xuICAgIHJldHVybiB7IC4uLnRoaXMucm91bmQocHJvcHMpLCB3aWR0aDogdywgaGVpZ2h0OiBodCwgZXh0cmE6IHBvcyB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb29yZHMoZWxlbTogSFRNTEVsZW1lbnQpOiBQb3NpdGlvbk1ldGEge1xuICAgIHJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjKHBsYWNlbWVudDogT3V0c2lkZVBsYWNlbWVudCwgc3JjLCBob3N0KTogb2JqZWN0IHtcbiAgICBjb25zdCBbbWFpbiwgc3ViXSA9IHBsYWNlbWVudC5zcGxpdCgnJyk7XG4gICAgY29uc3QgcCA9IHsgbGVmdDogMCwgdG9wOiAwIH07XG4gICAgaWYgKChtYWluID09PSAndCcgfHwgbWFpbiA9PT0gJ2InKSAmJiAhc3ViKSB7XG4gICAgICBwLmxlZnQgPSBzcmMubGVmdCArIChzcmMud2lkdGggLSBob3N0LndpZHRoKSAvIDI7XG4gICAgfVxuXG4gICAgaWYgKChtYWluID09PSAndCcgfHwgbWFpbiA9PT0gJ2InKSAmJiBzdWIpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0O1xuICAgIH1cbiAgICBpZiAoKG1haW4gPT09ICd0JyB8fCBtYWluID09PSAnYicpICYmIHN1YiA9PT0gJ3InKSB7XG4gICAgICBwLmxlZnQgPSBzcmMubGVmdCArIHNyYy53aWR0aCAtIGhvc3Qud2lkdGg7XG4gICAgfVxuICAgIGlmIChtYWluID09PSAnbCcpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0IC0gaG9zdC53aWR0aDtcbiAgICB9XG4gICAgaWYgKG1haW4gPT09ICdyJykge1xuICAgICAgcC5sZWZ0ID0gc3JjLnJpZ2h0O1xuICAgIH1cblxuICAgIGlmIChtYWluID09PSAndCcpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcCAtIGhvc3QuaGVpZ2h0O1xuICAgIH1cbiAgICBpZiAobWFpbiA9PT0gJ2InKSB7XG4gICAgICBwLnRvcCA9IHNyYy50b3AgKyBzcmMuaGVpZ2h0O1xuICAgIH1cbiAgICBpZiAobWFpbiA9PT0gJ2wnIHx8IG1haW4gPT09ICdyJykge1xuICAgICAgcC50b3AgPSBzcmMudG9wICsgKHNyYy5oZWlnaHQgLSBob3N0LmhlaWdodCkgLyAyO1xuICAgIH1cbiAgICBpZiAoc3ViID09PSAndCcgJiYgKG1haW4gPT09ICdsJyB8fCBtYWluID09PSAncicpKSB7XG4gICAgICBwLnRvcCA9IHNyYy50b3A7XG4gICAgfVxuICAgIGlmIChzdWIgPT09ICdiJyAmJiAobWFpbiA9PT0gJ2wnIHx8IG1haW4gPT09ICdyJykpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcCArIHNyYy5oZWlnaHQgLSBob3N0LmhlaWdodDtcbiAgICB9XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZVBvcyhwb3MsIHMsIGgsIGMgPSB0cnVlKTogeyBbeDogc3RyaW5nXTogYW55IH0ge1xuICAgIGNvbnN0IHByb3BzID0gdGhpcy5jYWxjKHBvcywgcywgaCk7XG5cbiAgICBpZiAoYyAmJiB0aGlzLmNvbmZpZy5hdXRvVXBkYXRlICYmIHRoaXMuaXNPdmVyZmxvd2VkKHsgLi4ucHJvcHMsIHdpZHRoOiBoLndpZHRoLCBoZWlnaHQ6IGguaGVpZ2h0IH0pKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWxjdWxhdGVQb3ModGhpcy5uZXh0UG9zaXRpb24ocG9zKSwgcywgaCwgZmFsc2UpO1xuICAgIH1cblxuICAgIHJldHVybiB7IHBvcywgcHJvcHMgfTtcbiAgfVxuXG4gIHByaXZhdGUgaXNPdmVyZmxvd2VkKHByb3BzOiB7IFt4OiBzdHJpbmddOiBhbnkgfSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGggfSA9IHdpbmRvdztcbiAgICBwcm9wcy5ib3R0b20gPSBwcm9wcy50b3AgKyBwcm9wcy5oZWlnaHQ7XG4gICAgcHJvcHMucmlnaHQgPSBwcm9wcy5sZWZ0ICsgcHJvcHMud2lkdGg7XG4gICAgcmV0dXJuIHByb3BzLmJvdHRvbSA+IGlubmVySGVpZ2h0IHx8IHByb3BzLnRvcCA8PSAwIHx8IHByb3BzLmxlZnQgPD0gMCB8fCBwcm9wcy5yaWdodCA+IGlubmVyV2lkdGg7XG4gIH1cblxuICBwcml2YXRlIG5leHRQb3NpdGlvbihjdXJyZW50OiBPdXRzaWRlUGxhY2VtZW50KTogc3RyaW5nIHtcbiAgICBjb25zdCBwbGFjZW1lbnRzID0gWyd0JywgJ2InLCAnbCcsICdyJywgJ3RsJywgJ2JsJywgJ3RyJywgJ2JyJywgJ2x0JywgJ3J0JywgJ2xiJywgJ3JiJ107XG5cbiAgICBjb25zdCBpbmRleCA9IHBsYWNlbWVudHMuaW5kZXhPZihjdXJyZW50KTtcbiAgICBjb25zdCBldmVuID0gaW5kZXggJSAyID09PSAwO1xuICAgIHJldHVybiBldmVuID8gcGxhY2VtZW50c1tpbmRleCArIDFdIDogcGxhY2VtZW50c1tpbmRleCAtIDFdO1xuICB9XG5cbiAgcHJpdmF0ZSByb3VuZChwcm9wczogb2JqZWN0KTogb2JqZWN0IHtcbiAgICBPYmplY3Qua2V5cyhwcm9wcykuZm9yRWFjaCh4ID0+IChwcm9wc1t4XSA9IE1hdGgucm91bmQocHJvcHNbeF0pKSk7XG4gICAgcmV0dXJuIHByb3BzO1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5EcmFnKHRpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub2JzKSB0aGlzLm9icy5kaXNjb25uZWN0KCk7XG4gICAgdGhpcy5vYnMgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihtdXRhdGlvbnNMaXN0ID0+IHtcbiAgICAgIGZvciAoY29uc3QgbXV0YXRpb24gb2YgbXV0YXRpb25zTGlzdCkge1xuICAgICAgICBpZiAobXV0YXRpb24udHlwZSA9PT0gJ2F0dHJpYnV0ZXMnKSBCdXMuc2VuZCh0aWQsICd0X2R5bnBvcycpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5vYnMub2JzZXJ2ZSh0aGlzLmNvbmZpZy5zcmMsIHtcbiAgICAgIGF0dHJpYnV0ZUZpbHRlcjogWydzdHlsZSddXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==