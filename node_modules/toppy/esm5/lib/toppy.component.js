/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ComponentFactoryResolver, ElementRef, Injector, ViewChild, ViewContainerRef } from '@angular/core';
import { Subject } from 'rxjs';
import { startWith, takeUntil, tap } from 'rxjs/operators';
import { Bus, cssClass, toCss } from './utils';
var ToppyComponent = /** @class */ (function () {
    function ToppyComponent(inj, cd, compResolver, elRef) {
        this.inj = inj;
        this.cd = cd;
        this.compResolver = compResolver;
        this.elRef = elRef;
        this.content = {
            type: "s" /* STRING */,
            data: '',
            props: {}
        };
        this.die = new Subject();
        this.pinj = Injector;
    }
    /**
     * @return {?}
     */
    ToppyComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.el = this.elRef.nativeElement;
        this.wrapperEl = this.el.querySelector('.t-wrapper');
        /** @type {?} */
        var cls = ['t-container', this.config.containerClass, this.position.getClassName()];
        if (this.config.closeOnDocClick) {
            cls = cls.concat(['no-pointers']);
        }
        this.el.setAttribute('data-tid', this.tid);
        cssClass('add', cls, "[data-tid='" + [this.tid] + "']");
        cssClass('add', [this.config.bodyClass]);
    };
    /**
     * @return {?}
     */
    ToppyComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.listenPos().subscribe();
        if (this.content.type === "c" /* COMPONENT */) {
            this.compInstance = this.setComponent(this.content.props);
            Bus.send(this.tid, 't_compins', this.compInstance);
        }
    };
    /**
     * @param {?} props
     * @return {?}
     */
    ToppyComponent.prototype.setComponent = /**
     * @param {?} props
     * @return {?}
     */
    function (props) {
        /** @type {?} */
        var compRef = this.compOutlet.createComponent(this.compResolver.resolveComponentFactory((/** @type {?} */ (this.content.data))));
        Object.assign(compRef.instance, props);
        compRef.changeDetectorRef.detectChanges();
        return compRef.instance;
    };
    /**
     * @param {?} data
     * @return {?}
     */
    ToppyComponent.prototype.updateTextContent = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (this.content.type === "s" /* STRING */) {
            this.content.data = data;
            this.cd.detectChanges();
        }
    };
    /**
     * @return {?}
     */
    ToppyComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        cssClass('remove', [this.config.bodyClass]);
        this.die.next(1);
        Bus.send(this.tid, 't_detach');
    };
    /**
     * @private
     * @return {?}
     */
    ToppyComponent.prototype.listenPos = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        return Bus.listen(this.tid, 't_dynpos').pipe(startWith(1), takeUntil(this.die), tap(function (e) {
            if (!e || !e.x)
                return _this.setPos();
            /** @type {?} */
            var coords = { left: e.x, top: e.y };
            _this.wrapperEl.style = toCss(coords);
        }));
    };
    /**
     * @private
     * @return {?}
     */
    ToppyComponent.prototype.setPos = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.position.getPositions(this.wrapperEl), extra = _a.extra, coords = tslib_1.__rest(_a, ["extra"]);
        if (this.extra !== extra) {
            this.extra = extra;
            this.cd.detectChanges();
        }
        Object.assign(coords, { visibility: 'visible', opacity: '1' });
        this.wrapperEl.style = toCss(coords);
        Bus.send(this.tid, 't_posupdate');
    };
    ToppyComponent.decorators = [
        { type: Component, args: [{
                    // tslint:disable-next-line:component-selector
                    selector: 'toppy',
                    template: "<div class=\"t-backdrop\" *ngIf=\"config.backdrop\" [ngClass]=\"config.backdropClass\"></div>\n<div class=\"t-wrapper\" [ngClass]=\"config.wrapperClass\" [class]=\"extra\" #wrapperEl>\n  <ng-container [ngSwitch]=\"content.type\">\n    <ng-container *ngSwitchCase=\"'s'\">\n      <div [class]=\"content.props.class\">{{ content.data }}</div>\n    </ng-container>\n    <ng-container *ngSwitchCase=\"'h'\"> <div [innerHTML]=\"content.data\"></div> </ng-container>\n    <ng-container *ngSwitchCase=\"'t'\">\n      <ng-container *ngTemplateOutlet=\"content.data; context: { $implicit: content.props }\"></ng-container>\n    </ng-container>\n    <ng-container *ngSwitchCase=\"'c'\"> <ng-template #compOutlet></ng-template> </ng-container>\n  </ng-container>\n</div>\n",
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    styles: [":host{left:0;position:fixed;top:0;width:100%;height:100%;pointer-events:none}:host.no-pointers{pointer-events:all}:host .t-backdrop{left:0;position:fixed;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}:host>div.t-wrapper{position:absolute;visibility:hidden;opacity:0;transition:opacity .2s;overflow:hidden;pointer-events:all}"]
                }] }
    ];
    /** @nocollapse */
    ToppyComponent.ctorParameters = function () { return [
        { type: Injector },
        { type: ChangeDetectorRef },
        { type: ComponentFactoryResolver },
        { type: ElementRef }
    ]; };
    ToppyComponent.propDecorators = {
        compOutlet: [{ type: ViewChild, args: ['compOutlet', { read: ViewContainerRef },] }]
    };
    return ToppyComponent;
}());
export { ToppyComponent };
if (false) {
    /** @type {?} */
    ToppyComponent.prototype.compOutlet;
    /** @type {?} */
    ToppyComponent.prototype.content;
    /** @type {?} */
    ToppyComponent.prototype.config;
    /** @type {?} */
    ToppyComponent.prototype.position;
    /** @type {?} */
    ToppyComponent.prototype.tid;
    /** @type {?} */
    ToppyComponent.prototype.el;
    /** @type {?} */
    ToppyComponent.prototype.wrapperEl;
    /** @type {?} */
    ToppyComponent.prototype.extra;
    /** @type {?} */
    ToppyComponent.prototype.pinj;
    /** @type {?} */
    ToppyComponent.prototype.compInstance;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.die;
    /** @type {?} */
    ToppyComponent.prototype.inj;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.cd;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.compResolver;
    /**
     * @type {?}
     * @private
     */
    ToppyComponent.prototype.elRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wcHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdG9wcHkvIiwic291cmNlcyI6WyJsaWIvdG9wcHkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUVMLHVCQUF1QixFQUN2QixpQkFBaUIsRUFDakIsU0FBUyxFQUNULHdCQUF3QixFQUN4QixVQUFVLEVBQ1YsUUFBUSxFQUdSLFNBQVMsRUFDVCxnQkFBZ0IsRUFDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUczRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0M7SUF3QkUsd0JBQ1MsR0FBYSxFQUNaLEVBQXFCLEVBQ3JCLFlBQXNDLEVBQ3RDLEtBQWlCO1FBSGxCLFFBQUcsR0FBSCxHQUFHLENBQVU7UUFDWixPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBMEI7UUFDdEMsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQW5CM0IsWUFBTyxHQUFZO1lBQ2pCLElBQUksa0JBQW9CO1lBQ3hCLElBQUksRUFBRSxFQUFFO1lBQ1IsS0FBSyxFQUFFLEVBQUU7U0FDVixDQUFDO1FBU00sUUFBRyxHQUFlLElBQUksT0FBTyxFQUFFLENBQUM7UUFRdEMsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7SUFDdkIsQ0FBQzs7OztJQUVELGlDQUFROzs7SUFBUjtRQUNFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQzs7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QW9COzs7OztJQUNwQiw0QkFBNkI7Ozs7O0lBQzdCLHNDQUE4Qzs7Ozs7SUFDOUMsK0JBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgRWxlbWVudFJlZixcbiAgSW5qZWN0b3IsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdDb250YWluZXJSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzdGFydFdpdGgsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udGVudCwgQ29udGVudFR5cGUsIFRJRCwgVG9wcHlDb25maWcgfSBmcm9tICcuL21vZGVscyc7XG5pbXBvcnQgeyBUb3BweVBvc2l0aW9uIH0gZnJvbSAnLi9wb3NpdGlvbi9wb3NpdGlvbic7XG5pbXBvcnQgeyBCdXMsIGNzc0NsYXNzLCB0b0NzcyB9IGZyb20gJy4vdXRpbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmNvbXBvbmVudC1zZWxlY3RvclxuICBzZWxlY3RvcjogJ3RvcHB5JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RlbXBsYXRlLmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9zdHlsZXMuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBUb3BweUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZCgnY29tcE91dGxldCcsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiB9KSBjb21wT3V0bGV0OiBWaWV3Q29udGFpbmVyUmVmO1xuICBjb250ZW50OiBDb250ZW50ID0ge1xuICAgIHR5cGU6IENvbnRlbnRUeXBlLlNUUklORyxcbiAgICBkYXRhOiAnJyxcbiAgICBwcm9wczoge31cbiAgfTtcbiAgY29uZmlnOiBUb3BweUNvbmZpZztcbiAgcG9zaXRpb246IFRvcHB5UG9zaXRpb247XG4gIHRpZDogVElEO1xuICBlbDogSFRNTEVsZW1lbnQgfCBhbnk7XG4gIHdyYXBwZXJFbDogSFRNTEVsZW1lbnQgfCBhbnk7XG4gIGV4dHJhOiBzdHJpbmc7XG4gIHBpbmo6IGFueTtcbiAgY29tcEluc3RhbmNlO1xuICBwcml2YXRlIGRpZTogU3ViamVjdDwxPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGluajogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBjZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBjb21wUmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmXG4gICkge1xuICAgIHRoaXMucGluaiA9IEluamVjdG9yO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5lbCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgICB0aGlzLndyYXBwZXJFbCA9IHRoaXMuZWwucXVlcnlTZWxlY3RvcignLnQtd3JhcHBlcicpO1xuICAgIGxldCBjbHMgPSBbJ3QtY29udGFpbmVyJywgdGhpcy5jb25maWcuY29udGFpbmVyQ2xhc3MsIHRoaXMucG9zaXRpb24uZ2V0Q2xhc3NOYW1lKCldO1xuICAgIGlmICh0aGlzLmNvbmZpZy5jbG9zZU9uRG9jQ2xpY2spIHtcbiAgICAgIGNscyA9IGNscy5jb25jYXQoWyduby1wb2ludGVycyddKTtcbiAgICB9XG4gICAgdGhpcy5lbC5zZXRBdHRyaWJ1dGUoJ2RhdGEtdGlkJywgdGhpcy50aWQpO1xuICAgIGNzc0NsYXNzKCdhZGQnLCBjbHMsIGBbZGF0YS10aWQ9JyR7W3RoaXMudGlkXX0nXWApO1xuICAgIGNzc0NsYXNzKCdhZGQnLCBbdGhpcy5jb25maWcuYm9keUNsYXNzXSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5saXN0ZW5Qb3MoKS5zdWJzY3JpYmUoKTtcbiAgICBpZiAodGhpcy5jb250ZW50LnR5cGUgPT09IENvbnRlbnRUeXBlLkNPTVBPTkVOVCkge1xuICAgICAgdGhpcy5jb21wSW5zdGFuY2UgPSB0aGlzLnNldENvbXBvbmVudCh0aGlzLmNvbnRlbnQucHJvcHMpO1xuICAgICAgQnVzLnNlbmQodGhpcy50aWQsICd0X2NvbXBpbnMnLCB0aGlzLmNvbXBJbnN0YW5jZSk7XG4gICAgfVxuICB9XG5cbiAgc2V0Q29tcG9uZW50KHByb3BzKSB7XG4gICAgY29uc3QgY29tcFJlZiA9IHRoaXMuY29tcE91dGxldC5jcmVhdGVDb21wb25lbnQoXG4gICAgICB0aGlzLmNvbXBSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0aGlzLmNvbnRlbnQuZGF0YSBhcyBhbnkpXG4gICAgKTtcbiAgICBPYmplY3QuYXNzaWduKGNvbXBSZWYuaW5zdGFuY2UsIHByb3BzKTtcbiAgICBjb21wUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICByZXR1cm4gY29tcFJlZi5pbnN0YW5jZTtcbiAgfVxuXG4gIHVwZGF0ZVRleHRDb250ZW50KGRhdGE6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbnRlbnQudHlwZSA9PT0gQ29udGVudFR5cGUuU1RSSU5HKSB7XG4gICAgICB0aGlzLmNvbnRlbnQuZGF0YSA9IGRhdGE7XG4gICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBjc3NDbGFzcygncmVtb3ZlJywgW3RoaXMuY29uZmlnLmJvZHlDbGFzc10pO1xuICAgIHRoaXMuZGllLm5leHQoMSk7XG4gICAgQnVzLnNlbmQodGhpcy50aWQsICd0X2RldGFjaCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5Qb3MoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gQnVzLmxpc3Rlbih0aGlzLnRpZCwgJ3RfZHlucG9zJykucGlwZShcbiAgICAgIHN0YXJ0V2l0aCgxKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRpZSksXG4gICAgICB0YXAoZSA9PiB7XG4gICAgICAgIGlmICghZSB8fCAhZS54KSByZXR1cm4gdGhpcy5zZXRQb3MoKTtcbiAgICAgICAgY29uc3QgY29vcmRzID0geyBsZWZ0OiBlLngsIHRvcDogZS55IH07XG4gICAgICAgIHRoaXMud3JhcHBlckVsLnN0eWxlID0gdG9Dc3MoY29vcmRzKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0UG9zKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgZXh0cmEsIC4uLmNvb3JkcyB9ID0gdGhpcy5wb3NpdGlvbi5nZXRQb3NpdGlvbnModGhpcy53cmFwcGVyRWwpO1xuICAgIGlmICh0aGlzLmV4dHJhICE9PSBleHRyYSkge1xuICAgICAgdGhpcy5leHRyYSA9IGV4dHJhO1xuICAgICAgdGhpcy5jZC5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICAgIE9iamVjdC5hc3NpZ24oY29vcmRzLCB7IHZpc2liaWxpdHk6ICd2aXNpYmxlJywgb3BhY2l0eTogJzEnIH0pO1xuICAgIHRoaXMud3JhcHBlckVsLnN0eWxlID0gdG9Dc3MoY29vcmRzKTtcbiAgICBCdXMuc2VuZCh0aGlzLnRpZCwgJ3RfcG9zdXBkYXRlJyk7XG4gIH1cbn1cbiJdfQ==