/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { animationFrameScheduler, fromEvent, merge as mergeObs, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, filter, map, observeOn, skipWhile, takeUntil, tap } from 'rxjs/operators';
import { ToppyComponent } from './toppy.component';
import { BodyEl, Bus, getContent } from './utils';
var ToppyControl = /** @class */ (function () {
    function ToppyControl(appRef, compResolver, injector) {
        var _this = this;
        this.appRef = appRef;
        this.compResolver = compResolver;
        this.injector = injector;
        this.updateTextContent = new Subject();
        this.isOpen = false;
        this.die = new Subject();
        this.updateTextContent.subscribe(function (content) {
            if (_this.isOpen)
                _this.comp.updateTextContent(content);
        });
    }
    /**
     * @return {?}
     */
    ToppyControl.prototype.open = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.isOpen)
            return;
        this.attach();
        if (this.viewEl) {
            mergeObs(this.onDocumentClick(), this.onWindowResize(), this.onEscClick()).subscribe();
            setTimeout(function () { return Bus.send(_this.tid, 't_dynpos'); }, 1);
        }
        Bus.send(this.tid, 't_open');
        this.isOpen = true;
    };
    /**
     * @return {?}
     */
    ToppyControl.prototype.close = /**
     * @return {?}
     */
    function () {
        if (!this.isOpen)
            return;
        this.dettach();
        this.die.next(1);
        Bus.send(this.tid, 't_close');
        this.isOpen = false;
    };
    /**
     * @return {?}
     */
    ToppyControl.prototype.toggle = /**
     * @return {?}
     */
    function () {
        return this.isOpen ? this.close() : this.open();
    };
    /**
     * @return {?}
     */
    ToppyControl.prototype.onEscClick = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return fromEvent(BodyEl, 'keydown').pipe(takeUntil(this.die), skipWhile(function () { return !_this.config.closeOnEsc; }), filter(function (e) { return (e.key === 'Escape' || e.key === 'Esc' || e.keyCode === 27) && e.target.nodeName === 'BODY'; }), tap(function (e) { return e.preventDefault(); }), map(function (e) { return e.target; }), tap(function () { return _this.close(); }));
    };
    /**
     * @return {?}
     */
    ToppyControl.prototype.onDocumentClick = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return fromEvent(this.viewEl, 'click').pipe(takeUntil(this.die), map(function (e) { return e.target; }), skipWhile(function () { return !_this.config.closeOnDocClick; }), filter(this.isNotHostElement.bind(this)), tap(function () {
            _this.config.docClickCallback();
            _this.close();
        }));
    };
    /**
     * @return {?}
     */
    ToppyControl.prototype.onWindowResize = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var onResize = fromEvent(window, 'resize');
        /** @type {?} */
        var onScroll = fromEvent(window, 'scroll', { passive: true });
        return mergeObs(onResize, onScroll).pipe(skipWhile(function () { return !_this.config.listenWindowEvents; }), takeUntil(this.die), debounceTime(5), observeOn(animationFrameScheduler), distinctUntilChanged(), tap(function () {
            Bus.send(_this.tid, 't_dynpos');
            _this.config.windowResizeCallback();
        }));
    };
    /**
     * @param {?} newPosition
     * @return {?}
     */
    ToppyControl.prototype.changePosition = /**
     * @param {?} newPosition
     * @return {?}
     */
    function (newPosition) {
        this.position = newPosition;
    };
    /**
     * @param {?} positionConfig
     * @return {?}
     */
    ToppyControl.prototype.updatePosition = /**
     * @param {?} positionConfig
     * @return {?}
     */
    function (positionConfig) {
        this.position.updateConfig(positionConfig);
    };
    /**
     * @param {?} content
     * @param {?=} props
     * @return {?}
     */
    ToppyControl.prototype.updateContent = /**
     * @param {?} content
     * @param {?=} props
     * @return {?}
     */
    function (content, props) {
        if (props === void 0) { props = {}; }
        this.content = getContent(content, tslib_1.__assign({}, this.content.props, props));
    };
    /**
     * @param {?} eventName
     * @return {?}
     */
    ToppyControl.prototype.listen = /**
     * @param {?} eventName
     * @return {?}
     */
    function (eventName) {
        return Bus.listen(this.tid, eventName);
    };
    /**
     * @private
     * @param {?} el
     * @return {?}
     */
    ToppyControl.prototype.isNotHostElement = /**
     * @private
     * @param {?} el
     * @return {?}
     */
    function (el) {
        /** @type {?} */
        var wrapperEl = this.viewEl.querySelector('.t-wrapper');
        return el !== wrapperEl && !wrapperEl.contains(el);
    };
    /**
     * @private
     * @return {?}
     */
    ToppyControl.prototype.attach = /**
     * @private
     * @return {?}
     */
    function () {
        /* create component */
        this.compFac = this.compResolver.resolveComponentFactory(ToppyComponent);
        this.compRef = this.compFac.create(this.injector);
        this.comp = this.compRef.instance;
        /* assign props */
        var _a = this, position = _a.position, content = _a.content, config = _a.config, tid = _a.tid;
        content.props.close = this.close.bind(this);
        Object.assign(this.comp, { position: position, content: content, config: config, tid: tid });
        /* attach view */
        this.hostView = this.compRef.hostView;
        this.appRef.attachView(this.hostView);
        this.viewEl = ((/** @type {?} */ (this.hostView))).rootNodes[0];
        BodyEl.appendChild(this.viewEl);
    };
    /**
     * @private
     * @return {?}
     */
    ToppyControl.prototype.dettach = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.hostView)
            return;
        this.appRef.detachView(this.hostView);
        this.compRef.destroy();
        this.hostView = this.viewEl = this.comp = null;
    };
    return ToppyControl;
}());
export { ToppyControl };
if (false) {
    /** @type {?} */
    ToppyControl.prototype.position;
    /** @type {?} */
    ToppyControl.prototype.config;
    /** @type {?} */
    ToppyControl.prototype.content;
    /** @type {?} */
    ToppyControl.prototype.tid;
    /** @type {?} */
    ToppyControl.prototype.comp;
    /** @type {?} */
    ToppyControl.prototype.updateTextContent;
    /** @type {?} */
    ToppyControl.prototype.hostView;
    /** @type {?} */
    ToppyControl.prototype.compRef;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.viewEl;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.isOpen;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.compFac;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.die;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.appRef;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.compResolver;
    /**
     * @type {?}
     * @private
     */
    ToppyControl.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wcHktY29udHJvbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3RvcHB5LyIsInNvdXJjZXMiOlsibGliL3RvcHB5LWNvbnRyb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFRQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLEtBQUssSUFBSSxRQUFRLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xHLE9BQU8sRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd2SCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWxEO0lBZUUsc0JBQ1UsTUFBc0IsRUFDdEIsWUFBc0MsRUFDdEMsUUFBa0I7UUFINUIsaUJBUUM7UUFQUyxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBMEI7UUFDdEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVo1QixzQkFBaUIsR0FBb0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUszQyxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBRWYsUUFBRyxHQUFlLElBQUksT0FBTyxFQUFFLENBQUM7UUFPdEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFBLE9BQU87WUFDdEMsSUFBSSxLQUFJLENBQUMsTUFBTTtnQkFBRSxLQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7OztJQUVELDJCQUFJOzs7SUFBSjtRQUFBLGlCQVdDO1FBVkMsSUFBSSxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU87UUFFeEIs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TSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLG1CQUFBLElBQUksQ0FBQyxRQUFRLEVBQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDOzs7OztJQUVPLDhCQUFPOzs7O0lBQWY7UUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFPO1FBRTNCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNqRCxDQUFDO0lBQ0gsbUJBQUM7QUFBRCxDQUFDLEFBeklELElBeUlDOzs7O0lBeElDLGdDQUF3Qjs7SUFDeEIsOEJBQW9COztJQUNwQiwrQkFBaUI7O0lBQ2pCLDJCQUFTOztJQUNULDRCQUFxQjs7SUFDckIseUNBQW1EOztJQUNuRCxnQ0FBa0I7O0lBQ2xCLCtCQUFzQzs7Ozs7SUFFdEMsOEJBQTRCOzs7OztJQUM1Qiw4QkFBdUI7Ozs7O0lBQ3ZCLCtCQUFrRDs7Ozs7SUFDbEQsMkJBQXdDOzs7OztJQUd0Qyw4QkFBOEI7Ozs7O0lBQzlCLG9DQUE4Qzs7Ozs7SUFDOUMsZ0NBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQXBwbGljYXRpb25SZWYsXG4gIENvbXBvbmVudEZhY3RvcnksXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgQ29tcG9uZW50UmVmLFxuICBJbmplY3RvcixcbiAgVmlld1JlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyLCBmcm9tRXZlbnQsIG1lcmdlIGFzIG1lcmdlT2JzLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgb2JzZXJ2ZU9uLCBza2lwV2hpbGUsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udGVudCwgQ29udGVudERhdGEsIENvbnRlbnRQcm9wcywgVElELCBUb3BweUNvbmZpZywgVG9wcHlFdmVudE5hbWUgfSBmcm9tICcuL21vZGVscyc7XG5pbXBvcnQgeyBUb3BweVBvc2l0aW9uIH0gZnJvbSAnLi9wb3NpdGlvbi9wb3NpdGlvbic7XG5pbXBvcnQgeyBUb3BweUNvbXBvbmVudCB9IGZyb20gJy4vdG9wcHkuY29tcG9uZW50JztcbmltcG9ydCB7IEJvZHlFbCwgQnVzLCBnZXRDb250ZW50IH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBUb3BweUNvbnRyb2wge1xuICBwb3NpdGlvbjogVG9wcHlQb3NpdGlvbjtcbiAgY29uZmlnOiBUb3BweUNvbmZpZztcbiAgY29udGVudDogQ29udGVudDtcbiAgdGlkOiBUSUQ7XG4gIGNvbXA6IFRvcHB5Q29tcG9uZW50O1xuICB1cGRhdGVUZXh0Q29udGVudDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3QoKTtcbiAgaG9zdFZpZXc6IFZpZXdSZWY7XG4gIGNvbXBSZWY6IENvbXBvbmVudFJlZjxUb3BweUNvbXBvbmVudD47XG5cbiAgcHJpdmF0ZSB2aWV3RWw6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGlzT3BlbiA9IGZhbHNlO1xuICBwcml2YXRlIGNvbXBGYWM6IENvbXBvbmVudEZhY3Rvcnk8VG9wcHlDb21wb25lbnQ+O1xuICBwcml2YXRlIGRpZTogU3ViamVjdDwxPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmLFxuICAgIHByaXZhdGUgY29tcFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7XG4gICAgdGhpcy51cGRhdGVUZXh0Q29udGVudC5zdWJzY3JpYmUoY29udGVudCA9PiB7XG4gICAgICBpZiAodGhpcy5pc09wZW4pIHRoaXMuY29tcC51cGRhdGVUZXh0Q29udGVudChjb250ZW50KTtcbiAgICB9KTtcbiAgfVxuXG4gIG9wZW4oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNPcGVuKSByZXR1cm47XG5cbiAgICB0aGlzLmF0dGFjaCgpO1xuICAgIGlmICh0aGlzLnZpZXdFbCkge1xuICAgICAgbWVyZ2VPYnModGhpcy5vbkRvY3VtZW50Q2xpY2soKSwgdGhpcy5vbldpbmRvd1Jlc2l6ZSgpLCB0aGlzLm9uRXNjQ2xpY2soKSkuc3Vic2NyaWJlKCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IEJ1cy5zZW5kKHRoaXMudGlkLCAndF9keW5wb3MnKSwgMSk7XG4gICAgfVxuXG4gICAgQnVzLnNlbmQodGhpcy50aWQsICd0X29wZW4nKTtcbiAgICB0aGlzLmlzT3BlbiA9IHRydWU7XG4gIH1cblxuICBjbG9zZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaXNPcGVuKSByZXR1cm47XG5cbiAgICB0aGlzLmRldHRhY2goKTtcbiAgICB0aGlzLmRpZS5uZXh0KDEpO1xuICAgIEJ1cy5zZW5kKHRoaXMudGlkLCAndF9jbG9zZScpO1xuICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7XG4gIH1cblxuICB0b2dnbGUoKTogdm9pZCB7XG4gICAgcmV0dXJuIHRoaXMuaXNPcGVuID8gdGhpcy5jbG9zZSgpIDogdGhpcy5vcGVuKCk7XG4gIH1cblxuICBvbkVzY0NsaWNrKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGZyb21FdmVudChCb2R5RWwsICdrZXlkb3duJykucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRpZSksXG4gICAgICBza2lwV2hpbGUoKCkgPT4gIXRoaXMuY29uZmlnLmNsb3NlT25Fc2MpLFxuICAgICAgZmlsdGVyKChlOiBhbnkpID0+IChlLmtleSA9PT0gJ0VzY2FwZScgfHwgZS5rZXkgPT09ICdFc2MnIHx8IGUua2V5Q29kZSA9PT0gMjcpICYmIGUudGFyZ2V0Lm5vZGVOYW1lID09PSAnQk9EWScpLFxuICAgICAgdGFwKGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKSxcbiAgICAgIG1hcChlID0+IGUudGFyZ2V0KSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNsb3NlKCkpXG4gICAgKTtcbiAgfVxuXG4gIG9uRG9jdW1lbnRDbGljaygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBmcm9tRXZlbnQodGhpcy52aWV3RWwsICdjbGljaycpLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5kaWUpLFxuICAgICAgbWFwKChlOiBhbnkpID0+IGUudGFyZ2V0KSxcbiAgICAgIHNraXBXaGlsZSgoKSA9PiAhdGhpcy5jb25maWcuY2xvc2VPbkRvY0NsaWNrKSxcbiAgICAgIGZpbHRlcih0aGlzLmlzTm90SG9zdEVsZW1lbnQuYmluZCh0aGlzKSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbmZpZy5kb2NDbGlja0NhbGxiYWNrKCk7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIG9uV2luZG93UmVzaXplKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgb25SZXNpemUgPSBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJyk7XG4gICAgY29uc3Qgb25TY3JvbGwgPSBmcm9tRXZlbnQod2luZG93LCAnc2Nyb2xsJywgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICAgIHJldHVybiBtZXJnZU9icyhvblJlc2l6ZSwgb25TY3JvbGwpLnBpcGUoXG4gICAgICBza2lwV2hpbGUoKCkgPT4gIXRoaXMuY29uZmlnLmxpc3RlbldpbmRvd0V2ZW50cyksXG4gICAgICB0YWtlVW50aWwodGhpcy5kaWUpLFxuICAgICAgZGVib3VuY2VUaW1lKDUpLFxuICAgICAgb2JzZXJ2ZU9uKGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICBCdXMuc2VuZCh0aGlzLnRpZCwgJ3RfZHlucG9zJyk7XG4gICAgICAgIHRoaXMuY29uZmlnLndpbmRvd1Jlc2l6ZUNhbGxiYWNrKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBjaGFuZ2VQb3NpdGlvbihuZXdQb3NpdGlvbjogVG9wcHlQb3NpdGlvbik6IHZvaWQge1xuICAgIHRoaXMucG9zaXRpb24gPSBuZXdQb3NpdGlvbjtcbiAgfVxuXG4gIHVwZGF0ZVBvc2l0aW9uKHBvc2l0aW9uQ29uZmlnOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnBvc2l0aW9uLnVwZGF0ZUNvbmZpZyhwb3NpdGlvbkNvbmZpZyk7XG4gIH1cblxuICB1cGRhdGVDb250ZW50KGNvbnRlbnQ6IENvbnRlbnREYXRhLCBwcm9wczogQ29udGVudFByb3BzID0ge30pOiB2b2lkIHtcbiAgICB0aGlzLmNvbnRlbnQgPSBnZXRDb250ZW50KGNvbnRlbnQsIHsgLi4udGhpcy5jb250ZW50LnByb3BzLCAuLi5wcm9wcyB9KTtcbiAgfVxuXG4gIGxpc3RlbihldmVudE5hbWU6IFRvcHB5RXZlbnROYW1lKSB7XG4gICAgcmV0dXJuIEJ1cy5saXN0ZW4odGhpcy50aWQsIGV2ZW50TmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGlzTm90SG9zdEVsZW1lbnQoZWwpOiBib29sZWFuIHtcbiAgICBjb25zdCB3cmFwcGVyRWwgPSB0aGlzLnZpZXdFbC5xdWVyeVNlbGVjdG9yKCcudC13cmFwcGVyJyk7XG4gICAgcmV0dXJuIGVsICE9PSB3cmFwcGVyRWwgJiYgIXdyYXBwZXJFbC5jb250YWlucyhlbCk7XG4gIH1cblxuICBwcml2YXRlIGF0dGFjaCgpOiB2b2lkIHtcbiAgICAvKiBjcmVhdGUgY29tcG9uZW50ICovXG4gICAgdGhpcy5jb21wRmFjID0gdGhpcy5jb21wUmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoVG9wcHlDb21wb25lbnQpO1xuICAgIHRoaXMuY29tcFJlZiA9IHRoaXMuY29tcEZhYy5jcmVhdGUodGhpcy5pbmplY3Rvcik7XG4gICAgdGhpcy5jb21wID0gdGhpcy5jb21wUmVmLmluc3RhbmNlO1xuXG4gICAgLyogYXNzaWduIHByb3BzICovXG4gICAgY29uc3QgeyBwb3NpdGlvbiwgY29udGVudCwgY29uZmlnLCB0aWQgfSA9IHRoaXM7XG4gICAgY29udGVudC5wcm9wcy5jbG9zZSA9IHRoaXMuY2xvc2UuYmluZCh0aGlzKTtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMuY29tcCwgeyBwb3NpdGlvbiwgY29udGVudCwgY29uZmlnLCB0aWQgfSk7XG5cbiAgICAvKiBhdHRhY2ggdmlldyAqL1xuICAgIHRoaXMuaG9zdFZpZXcgPSB0aGlzLmNvbXBSZWYuaG9zdFZpZXc7XG4gICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyh0aGlzLmhvc3RWaWV3KTtcbiAgICB0aGlzLnZpZXdFbCA9ICh0aGlzLmhvc3RWaWV3IGFzIGFueSkucm9vdE5vZGVzWzBdO1xuICAgIEJvZHlFbC5hcHBlbmRDaGlsZCh0aGlzLnZpZXdFbCk7XG4gIH1cblxuICBwcml2YXRlIGRldHRhY2goKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmhvc3RWaWV3KSByZXR1cm47XG5cbiAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KHRoaXMuaG9zdFZpZXcpO1xuICAgIHRoaXMuY29tcFJlZi5kZXN0cm95KCk7XG4gICAgdGhpcy5ob3N0VmlldyA9IHRoaXMudmlld0VsID0gdGhpcy5jb21wID0gbnVsbDtcbiAgfVxufVxuIl19